<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>금융회사지배구조 · 주주 네트워크 탐색</title>
<!-- CTO: Favicon 추가 (404 에러 방지, 브랜딩 일관성) -->
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23d85604'/><path d='M30 50 L45 35 L45 45 L70 45 L70 55 L45 55 L45 65 Z' fill='white'/></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="graph.css?v=6"/>
<!-- Vis.js for smooth UX (hybrid: PyGraphviz layout + Vis.js rendering) -->
<link href="https://unpkg.com/vis-network/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js" defer></script>
<!-- API Base: 로컬(localhost)이면 미설정 → graph.js가 http://localhost:8000 사용, 배포 시에만 원격 URL 설정 -->
<script>
  (function() {
    var isLocal = !window.location.hostname || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    if (!isLocal) {
      window.GRAPHIQ_API_BASE = 'https://stock-graph-y8v7.onrender.com';
    }
  })();
</script>
</head>
<body>

<!-- ═════════════════ TOP BAR ═════════════════ -->
<div class="topbar">
  <div class="logo" id="logoHome" role="button" aria-label="홈으로 이동" tabindex="0">
    <div class="logo-mark">
      <svg class="logo-icon" viewBox="0 0 13 13" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle cx="2.5" cy="2.5" r="1.5" fill="white" opacity=".9"/>
        <circle cx="10.5" cy="2.5" r="1.5" fill="white" opacity=".9"/>
        <circle cx="2.5" cy="10.5" r="1.5" fill="white" opacity=".9"/>
        <circle cx="10.5" cy="10.5" r="1.5" fill="white" opacity=".9"/>
        <circle cx="6.5" cy="6.5" r="2" fill="white"/>
        <line x1="2.5" y1="2.5" x2="6.5" y2="6.5" stroke="white" stroke-width=".8" opacity=".5"/>
        <line x1="10.5" y1="2.5" x2="6.5" y2="6.5" stroke="white" stroke-width=".8" opacity=".5"/>
        <line x1="2.5" y1="10.5" x2="6.5" y2="6.5" stroke="white" stroke-width=".8" opacity=".5"/>
        <line x1="10.5" y1="10.5" x2="6.5" y2="6.5" stroke="white" stroke-width=".8" opacity=".5"/>
      </svg>
    </div>
    <span class="logo-name">금융회사지배구조</span>
  </div>

  <div class="topbar-sep"></div>

  <div class="search-wrap">
    <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><circle cx="5.5" cy="5.5" r="4" stroke="currentColor" stroke-width="1.2"/><path d="M9 9l2.5 2.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>
    <input class="search-input" placeholder="회사명, 주주명 검색..." id="nodeSearch" autocomplete="off"/>
    <div class="search-results hidden" id="searchResults"></div>
  </div>

  <div class="topbar-sep"></div>

  <div class="filter-group">
    <span class="filter-group-label">필터:</span>
    <div class="filter-pill active" data-filter="company" onclick="toggleFilter(this)">
      <div class="filter-dot"></div>
      <span class="filter-label">회사</span>
    </div>
    <div class="filter-pill active" data-filter="person" onclick="toggleFilter(this)">
      <div class="filter-dot"></div>
      <span class="filter-label">개인주주</span>
    </div>
    <div class="filter-pill active" data-filter="major" onclick="toggleFilter(this)">
      <div class="filter-dot"></div>
      <span class="filter-label">최대주주</span>
    </div>
    <div class="filter-pill active" data-filter="institution" onclick="toggleFilter(this)">
      <div class="filter-dot"></div>
      <span class="filter-label">기관</span>
    </div>
  </div>

  <div class="topbar-right">
    <div class="status-dot"><span class="sdot" id="statusDot"></span><span id="statusText">초기화 중...</span></div>
    <div class="topbar-sep"></div>
    <button class="tb-btn" id="resetViewBtn">
      <svg width="11" height="11" viewBox="0 0 11 11" fill="none"><path d="M2 5.5a3.5 3.5 0 1 1 1 2.45" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/><path d="M2 8V5.5H4.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      초기화
    </button>
  </div>
</div>

<!-- ═════════════════ MAIN ═════════════════ -->
<div class="main">

  <!-- GRAPH -->
  <!-- ═══════════════════════════════════════════════════════════════════════════
       GRAPH AREA (Vis.js 기반, 접근성 강화)
       CTO: 확장성/유지보수성/일관성/호환성/협업 코드 고려
       - role="main": 메인 콘텐츠 영역 명시
       - aria-label: 스크린 리더 지원
       - data-wheel-bound: 휠 이벤트 바인딩 플래그
  ═══════════════════════════════════════════════════════════════════════════ -->
  <div class="graph-area" id="graphArea" role="main" aria-label="그래프 시각화 영역" data-wheel-bound="1">
    
    <!-- ═════════════════ LOADING OVERLAY (Unified Variant) ═════════════════ -->
    <!-- CTO: 단계별 진행률 표시, 프로그레스바, 단계 인디케이터 포함 -->
    <div class="loading-overlay variant-unified hidden has-progress" id="loadingOverlay" aria-live="polite" aria-busy="false">
      <div class="loading-spinner"></div>
      <div class="loading-message-wrap">
        <div class="loading-text" id="loadingText">UI 구성 중…</div>
        <div class="loading-guidance" id="loadingGuidance" style="display: none;"></div>
      </div>
      <div class="loading-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="로딩 진행률">
        <div class="loading-bar" id="loadingBar"></div>
      </div>
      <div class="loading-steps" id="loadingSteps">
        <div class="step-item">
          <div class="step-dot"></div>
          <span class="step-label">연결</span>
        </div>
        <div class="step-line"></div>
        <div class="step-item">
          <div class="step-dot"></div>
          <span class="step-label">로딩</span>
        </div>
        <div class="step-line"></div>
        <div class="step-item">
          <div class="step-dot"></div>
          <span class="step-label">렌더링</span>
        </div>
      </div>
    </div>

    <!-- ═════════════════ VIS.JS NETWORK CONTAINER ═════════════════ -->
    <div id="visNetwork" aria-label="그래프 네트워크" data-drag-sync-bound="1"></div>
    <!-- 지배구조 맵: 가중치 엣지 히트맵 뷰 (Ego 그래프와 전환 가능) -->
    <div id="egoHeatmapWrap" class="ego-heatmap-wrap util-hidden" aria-label="가중치 엣지 히트맵"></div>
    
    <!-- ═════════════════ TOOLTIP ═════════════════ -->
    <!-- CTO: ID 변경 (tooltip → graphTooltip), role="tooltip" 추가 -->
    <div id="graphTooltip" role="tooltip" aria-hidden="true"></div>

    <!-- ═════════════════ GRAPH STATISTICS ═════════════════ -->
    <!-- CTO: 새로운 통계 영역 (노드/엣지 수, 필터 상태 등) -->
    <div class="graph-stats" id="graphStats" aria-label="그래프 통계"></div>

    <!-- ═════════════════ ZOOM CONTROLS ═════════════════ -->
    <!-- CTO: 접근성 강화 (role="group", aria-label 추가) -->
    <div class="zoom-controls" role="group" aria-label="줌 컨트롤">
      <button class="zoom-btn" id="zoomIn" title="확대">+</button>
      <button class="zoom-btn" id="zoomOut" title="축소">−</button>
      <button class="zoom-btn zoom-btn--icon" id="zoomFit" title="전체보기">⊡</button>
    </div>

    <!-- ═════════════════ GRAPH LEGEND ═════════════════ -->
    <!-- CTO: ID 추가 (id="legend"), 접근성 강화 (role="group", aria-label) -->
    <div class="graph-legend" id="legend" role="group" aria-label="노드 타입 범례">
      <div class="legend-title">노드 유형</div>
      <div class="legend-row" data-count-type="company">
        <div class="lc"></div>
        <span class="legend-label">회사</span>
        <span class="legend-count" data-count-type="company">0 건</span>
      </div>
      <div class="legend-row" data-count-type="person">
        <div class="lc"></div>
        <span class="legend-label">개인주주</span>
        <span class="legend-count" data-count-type="person">0 건</span>
      </div>
      <div class="legend-row" data-count-type="major">
        <div class="lc"></div>
        <span class="legend-label">최대주주</span>
        <span class="legend-count" data-count-type="major">0 건</span>
      </div>
      <div class="legend-row" data-count-type="institution">
        <div class="lc"></div>
        <span class="legend-label">기관</span>
        <span class="legend-count" data-count-type="institution">0 건</span>
      </div>
    </div>

  </div>

  <!-- RIGHT PANEL -->
  <div class="side-panel" id="sidePanel">
    <div class="panel-toggle-btn" id="panelToggle" onclick="togglePanel()">
      <svg width="8" height="12" viewBox="0 0 8 12" fill="none"><path d="M2 2l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
    <div class="panel-tabs">
      <div class="ptab active" data-tab="detail" onclick="switchTab(this)">노드 상세</div>
      <div class="ptab" data-tab="chat" onclick="switchTab(this)">AI 질문</div>
    </div>
    <div id="egoBanner" class="ego-banner util-hidden" role="region" aria-label="지배구조 맵">
      <span class="ego-banner-label" id="egoBannerLabel">지배구조 맵</span>
      <div class="ego-banner-actions">
        <button type="button" class="ego-view-btn" id="egoViewHeatmapBtn" title="가중치(지분율) 행렬로 보기">히트맵</button>
        <button type="button" class="ego-view-btn" id="egoViewEgoBtn" title="노드-링크 그래프로 보기">Ego 그래프</button>
      </div>
      <button type="button" class="ego-exit-btn">전체 그래프로 돌아가기</button>
    </div>

    <div class="panel-body" id="detailTab">
      <div class="panel-empty" id="panelEmpty">
        <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
          <circle cx="14" cy="14" r="6" stroke="#c9bdb2" stroke-width="2"/>
          <circle cx="34" cy="14" r="6" stroke="#c9bdb2" stroke-width="2"/>
          <circle cx="14" cy="34" r="6" stroke="#c9bdb2" stroke-width="2"/>
          <circle cx="34" cy="34" r="6" stroke="#c9bdb2" stroke-width="2"/>
          <circle cx="24" cy="24" r="7" stroke="#c9bdb2" stroke-width="2"/>
          <line x1="19" y1="19" x2="14" y2="14" stroke="#c9bdb2" stroke-width="1.5"/>
          <line x1="29" y1="19" x2="34" y2="14" stroke="#c9bdb2" stroke-width="1.5"/>
          <line x1="19" y1="29" x2="14" y2="34" stroke="#c9bdb2" stroke-width="1.5"/>
          <line x1="29" y1="29" x2="34" y2="34" stroke="#c9bdb2" stroke-width="1.5"/>
        </svg>
        <p>그래프에서 노드를 클릭하면<br/>상세 정보를 확인할 수 있습니다</p>
        <span>노드를 드래그하여 그래프를 탐색하세요</span>
      </div>
      <div class="node-detail" id="nodeDetail"></div>
    </div>

    <div class="panel-body chat-section util-hidden" id="chatTab">
      <div class="chat-context-bar util-hidden" id="ctxBar">
        <svg width="11" height="11" viewBox="0 0 11 11" fill="none"><circle cx="5.5" cy="5.5" r="4.5" stroke="#d85604" stroke-width="1"/><path d="M5.5 3v3l2 1.5" stroke="#d85604" stroke-width="1" stroke-linecap="round"/></svg>
        <span class="ctx-label">컨텍스트:</span>
        <span class="ctx-chip" id="ctxChip"></span>
        <span class="ctx-clear" onclick="clearContext()">✕</span>
      </div>

      <div class="chat-msgs" id="chatMsgs">
        <div id="sugState" class="anim">
          <div style="font-size:12px;color:var(--text-3);margin-bottom:10px;">
            노드를 선택하거나 아래 질문을 눌러보세요
          </div>
          <div class="suggestions" id="globalSugs">
            <button class="sug-item" data-q="지분율 50% 이상인 최대주주 목록을 보여줘">지분율 50% 이상 최대주주 목록</button>
            <button class="sug-item" data-q="우선주 보유 비중이 높은 회사 TOP 10을 보여줘">우선주 보유 비중이 높은 회사 TOP 10</button>
            <button class="sug-item" data-q="2022년 등기임원 평균보수가 가장 높은 회사 TOP 5">임원보수 TOP 5 (2022년)</button>
            <button class="sug-item" data-q="3개 이상 법인에 투자한 주주를 찾아줘">다중 법인 투자 주주</button>
          </div>
        </div>
      </div>

      <div class="chat-input-area">
        <div class="chat-input-wrap">
          <textarea class="chat-textarea" id="chatInput" rows="1" placeholder="자연어로 질문하세요 (예: 지분율 50% 이상 최대주주)"></textarea>
          <button class="chat-send" id="chatSend">
            <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M2 10V3a1 1 0 011-1h7a1 1 0 011 1v5a1 1 0 01-1 1H4L2 10z" stroke="white" stroke-width="1.3" stroke-linejoin="round"/></svg>
          </button>
        </div>
        <!-- CTO: 대화 초기화 버튼 (컨텍스트 초과 에러 해결을 위한 명확한 UX) -->
        <button class="chat-reset-btn" id="chatResetBtn" title="대화 이력 초기화">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
            <path d="M6 2v3l2-2M6 5l-2-2M2 6a4 4 0 1 1 8 0" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          대화 초기화
        </button>
      </div>
    </div>
  </div>
</div>

<script src="graph.js" defer></script>
</body>
</html>
