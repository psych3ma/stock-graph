# CTO Review: AI 질문 답변 형식 문제 분석

**검토자**: Cypher 및 Neo4j 전문가 출신 CTO  
**작업 일자**: 2026-02-19  
**검토 기준**: 호환성, 일관성, 유지보수성, 확장성, 협업 코드

---

## 📋 문제 분석

### 사용자 관찰

**사용자 질문**: "왜 주주인 한양학원이 두번이나 나와?"

**현재 AI 답변**:
> "한양증권(주) 송파알엠센터의 주주인 한양학원은 두 번 출현했지만, 이는 데이터 중복으로 보입니다. 출현 횟수는 12회로 동일하며, 이는 한양학원이 여러 차례 주주로 등록되었거나, 다른 기준으로 중복 기록된 것일 수 있습니다. 데이터의 정확성을 위해 추가적인 검토가 필요할 수 있습니다."

**사용자가 기대한 답변 형식**:
- "x0년 15%, x1년 16%" 같은 형식으로 **연도별 지분율을 구체적으로 표시**
- Neo4j에서 실제 데이터를 조회했으므로, `baseDate`나 `reportYear`를 활용한 시계열 데이터를 보여줘야 함

**문제점**:
- ❌ 구체적인 수치(연도별 지분율)를 보여주지 않음
- ❌ "데이터 중복으로 보입니다" 같은 추상적인 설명만 제공
- ❌ 실제 DB 조회 결과(`baseDate`, `reportYear`, `stockRatio`)를 활용하지 않음

---

## 근본 원인 분석

### 문제 1: QA_PROMPT가 시계열 데이터 포맷팅을 명시하지 않음

**현재 QA_PROMPT** (`backend/app/services/graph_service.py:123-147`):
```
[답변 규칙]
- 핵심 수치(지분율·금액·건수) 먼저, 금액은 "X억 X천만원" 형식
- 결과가 비어있거나 없으면:
  1. 왜 데이터가 없는지 분석 (쿼리 문제인지, 실제 데이터 부재인지)
  2. 대안 쿼리나 다른 접근 방법 제시
  3. 사용자가 원하는 정보를 찾을 수 있는 다른 방법 제안
  4. 예: "지분율 변동을 찾으려면 baseDate나 reportYear로 시간순 정렬하여 비교해야 합니다. 특정 회사나 기간을 지정해보시겠어요?"
  5. 가능하면 DB에 있는 실제 데이터를 활용한 대안 제시
- 결과가 있으면 4줄 이내 간결하게 답변
```

**문제점**:
1. **시계열 데이터 포맷팅 가이드라인 부재**
   - `baseDate`나 `reportYear`가 있는 경우 어떻게 포맷팅해야 하는지 명시되지 않음
   - "x0년 15%, x1년 16%" 같은 형식에 대한 지시 없음

2. **구체적 수치 표시 요구사항 부재**
   - "핵심 수치 먼저"라고만 되어 있지만, 시계열 데이터의 경우 연도별로 구체적으로 표시해야 한다는 지시 없음

3. **DB 결과 활용 방법 불명확**
   - DB에서 `baseDate`, `reportYear`, `stockRatio`를 조회했을 때 이를 어떻게 조합하여 답변해야 하는지 불명확

### 문제 2: Cypher 쿼리가 시계열 데이터를 반환하지 않을 수 있음

**가능한 시나리오**:
- LangChain이 생성한 Cypher 쿼리가 `baseDate`나 `reportYear`를 `RETURN` 절에 포함하지 않았을 수 있음
- 또는 `max(r.stockRatio)`만 반환하고 시계열 정보는 반환하지 않았을 수 있음

**영향**:
- QA_PROMPT가 시계열 데이터를 받지 못하면 포맷팅할 수 없음
- DB 결과에 `baseDate`/`reportYear`가 없으면 LLM이 추론만 할 수 있음

### 문제 3: LLM이 DB 결과를 제대로 활용하지 않음

**현재 동작**:
- LLM이 DB 결과를 받았지만, 구체적인 수치를 추출하지 않고 추상적인 설명만 제공
- "데이터 중복으로 보입니다" 같은 추론에 그침

**원인**:
- QA_PROMPT가 DB 결과를 구체적으로 포맷팅하도록 명시하지 않음
- 시계열 데이터가 있을 때 연도별로 표시하라는 지시 없음

---

## 해결 방안 (코드 수정 없이 분석만)

### 해결책 1: QA_PROMPT에 시계열 데이터 포맷팅 가이드라인 추가

**필요한 개선**:
```
[답변 규칙]
- 핵심 수치(지분율·금액·건수) 먼저, 금액은 "X억 X천만원" 형식
- **시계열 데이터가 있는 경우 (baseDate, reportYear 포함)**:
  - 연도별로 구체적인 수치를 표시: "2020년 15%, 2021년 16%" 형식
  - 시간순으로 정렬하여 표시
  - 각 연도/기준일자별 지분율을 명확히 구분
- 결과가 비어있거나 없으면:
  ...
```

**효과**:
- LLM이 시계열 데이터를 받았을 때 올바른 형식으로 포맷팅
- 사용자가 기대하는 "x0년 15%, x1년 16%" 형식의 답변 생성

### 해결책 2: Cypher 프롬프트에 시계열 데이터 반환 지시 추가

**필요한 개선**:
```
[작성 규칙]
...
6. **시계열 질문의 경우** (지분율 변동, 연도별 비교 등):
   - baseDate 또는 reportYear를 반드시 RETURN 절에 포함
   - stockRatio와 함께 반환하여 연도별 지분율을 비교할 수 있도록 함
   - 예: RETURN s.stockName, r.stockRatio, r.reportYear ORDER BY r.reportYear
```

**효과**:
- LangChain이 시계열 데이터를 포함한 Cypher 쿼리 생성
- QA_PROMPT가 시계열 데이터를 받아 포맷팅 가능

### 해결책 3: DB 결과 활용 강화

**필요한 개선**:
```
[답변 규칙]
- **DB 결과를 반드시 활용**: DB에서 조회한 실제 수치를 그대로 사용
- 추상적인 설명("데이터 중복으로 보입니다")보다 구체적인 수치("2020년 15%, 2021년 16%")를 우선 표시
- DB 결과에 baseDate나 reportYear가 있으면 반드시 연도별로 표시
```

**효과**:
- LLM이 DB 결과를 제대로 활용하여 구체적인 답변 생성
- 추상적인 설명 대신 실제 데이터 기반 답변 제공

---

## 호환성 검토

### LangChain 호환성

**확인 사항**:
- 프롬프트 수정만으로 해결 가능
- `GraphCypherQAChain`의 동작에 영향 없음

**결과**: ✅ 호환성 유지

---

## 일관성 검토

### 답변 형식 일관성

**개선 사항**:
- 시계열 데이터에 대한 일관된 포맷팅 규칙
- 모든 시계열 질문에 동일한 형식 적용

**결과**: ✅ 일관성 향상

---

## 유지보수성 검토

### 프롬프트 관리

**개선 사항**:
- 시계열 데이터 포맷팅 규칙을 명시하여 유지보수 용이
- 새로운 시계열 질문 유형 추가 시에도 동일 규칙 적용

**결과**: ✅ 유지보수성 향상

---

## 확장성 검토

### 다른 시계열 질문에 적용 가능

**개선 사항**:
- 시계열 데이터 포맷팅 규칙은 다른 질문 유형에도 적용 가능
- 연도별 비교, 기간별 변동 등 다양한 시나리오에 활용 가능

**결과**: ✅ 확장성 향상

---

## 협업 코드 검토

### 문서화

**개선 사항**:
- 시계열 데이터 포맷팅 규칙을 프롬프트에 명시하여 다른 개발자가 이해하기 쉬움
- 답변 형식에 대한 명확한 가이드라인 제공

**결과**: ✅ 협업 코드 품질 향상

---

## 📊 개선 효과 요약

### 문제 해결

**Before**:
- ❌ "데이터 중복으로 보입니다" 같은 추상적인 답변
- ❌ 구체적인 수치(연도별 지분율) 미제시
- ❌ DB 결과를 제대로 활용하지 않음

**After** (개선 후 예상):
- ✅ "2020년 15%, 2021년 16%" 같은 구체적인 답변
- ✅ 연도별 지분율을 명확히 표시
- ✅ DB 결과를 활용한 실제 데이터 기반 답변

### 코드 품질

**Before**:
- ⚠️ 시계열 데이터 포맷팅 가이드라인 부재
- ⚠️ DB 결과 활용 방법 불명확

**After** (개선 후 예상):
- ✅ 시계열 데이터 포맷팅 규칙 명시
- ✅ DB 결과 활용 방법 명확화

---

## 권장 사항

### P0 - Critical (즉시 개선)

1. **QA_PROMPT에 시계열 데이터 포맷팅 가이드라인 추가**
   - "x0년 15%, x1년 16%" 형식 명시
   - 연도별 수치 표시 요구사항 추가

2. **DB 결과 활용 강화**
   - 추상적인 설명 대신 구체적인 수치 우선 표시
   - `baseDate`/`reportYear`가 있으면 반드시 연도별로 표시

### P1 - High (단기 개선)

3. **Cypher 프롬프트에 시계열 데이터 반환 지시 추가**
   - 시계열 질문의 경우 `baseDate`/`reportYear`를 반드시 반환하도록 지시
   - `stockRatio`와 함께 반환하여 연도별 비교 가능하도록 함

---

## 🔍 관련 파일

### 백엔드
- `backend/app/services/graph_service.py`:
  - `QA_PROMPT`: 답변 형식 규칙 정의
  - `CYPHER_PROMPT`: Cypher 쿼리 생성 규칙 정의

### 문서
- `docs/CTO-AI-ANSWER-FORMAT-REVIEW.md`: 본 문서

---

## ✅ 테스트 체크리스트 (개선 후)

- [ ] 시계열 질문에 "x0년 15%, x1년 16%" 형식 답변 생성 확인
- [ ] DB 결과에 `baseDate`/`reportYear`가 있을 때 연도별 표시 확인
- [ ] 추상적인 설명 대신 구체적인 수치 우선 표시 확인
- [ ] Cypher 쿼리가 시계열 데이터를 반환하는지 확인

---

## 관련 문서

- `docs/CTO-AI-QUESTION-DATA-SEARCH-FIX.md`: 초기 프롬프트 개선 문서
- `docs/CTO-AI-ANSWER-FORMAT-REVIEW.md`: 본 문서
