# CTO Review: ì—°ê²° ë…¸ë“œ ì¤‘ë³µ ë¬¸ì œ ë¶„ì„

**ê²€í† ìž**: Neo4j ì „ë¬¸ê°€ ì¶œì‹  CTO  
**ìž‘ì—… ì¼ìž**: 2026-02-19  
**ê²€í†  ê¸°ì¤€**: í˜¸í™˜ì„±, ì¼ê´€ì„±, ìœ ì§€ë³´ìˆ˜ì„±, í™•ìž¥ì„±, í˜‘ì—… ì½”ë“œ

---

## ðŸ“‹ ë¬¸ì œ ë¶„ì„

### ì‚¬ìš©ìž ê´€ì°°

**ì¦ìƒ**: ì—°ê²° ë…¸ë“œ ëª©ë¡ì— ê°™ì€ ë…¸ë“œê°€ ì¤‘ë³µìœ¼ë¡œ ë‚˜íƒ€ë‚¨
- ì˜ˆ: "í•œì–‘í•™ì›"ì´ 16.3%ì™€ 14.6%ë¡œ ë‘ ë²ˆ í‘œì‹œë¨

**ì‚¬ìš©ìž ì§ˆë¬¸**: "ì¤‘ë³µì€ ê¸°ì¤€ì¼ìžê°€ ë‹¬ë¼ì„œì•¼?" (Are the duplicates due to different reference dates?)

---

## ê·¼ë³¸ ì›ì¸ ë¶„ì„

### ë°ì´í„° ëª¨ë¸

**Neo4j ê´€ê³„ êµ¬ì¡°**:
```cypher
(s:Stockholder)-[r:HOLDS_SHARES]->(c:Company)
```

**ê´€ê³„ ì†ì„±**:
- `stockRatio` (Float, ì§€ë¶„ìœ¨%)
- `stockCount` (Int)
- `stockType` (ë³´í†µì£¼|ìš°ì„ ì£¼)
- `baseDate` (Date, ê¸°ì¤€ì¼ìž)
- `reportYear` (Int, ë³´ê³ ì—°ë„)

**ì¤‘ìš”í•œ ì **:
- ê°™ì€ `(Stockholder)-[:HOLDS_SHARES]->(Company)` ìŒì— ëŒ€í•´ **ì—¬ëŸ¬ ê°œì˜ ê´€ê³„ê°€ ì¡´ìž¬í•  ìˆ˜ ìžˆìŒ**
- ê° ê´€ê³„ëŠ” ë‹¤ë¥¸ `baseDate` ë˜ëŠ” `reportYear`ë¥¼ ê°€ì§ˆ ìˆ˜ ìžˆìŒ
- ì˜ˆ: í•œì–‘í•™ì›ì´ 2020ë…„ì— 16.3%, 2021ë…„ì— 14.6%ë¥¼ ë³´ìœ 

### í˜„ìž¬ ì¿¼ë¦¬ ë¶„ì„

**íŒŒì¼**: `backend/app/api/v1/endpoints/graph.py:433-440`

**í˜„ìž¬ ì¿¼ë¦¬**:
```cypher
MATCH (n)-[r:HOLDS_SHARES]-(m)
WHERE id(n) = $id
WITH m, labels(m) AS labels, properties(m) AS props, max(r.stockRatio) AS ratio
RETURN id(m) AS id, labels, props, ratio
ORDER BY ratio DESC
LIMIT 20
```

**ë¬¸ì œì  ë¶„ì„**:

1. **`WITH m`ì˜ ë™ìž‘**:
   - `WITH m`ì€ ë…¸ë“œ `m`ì„ ê·¸ë£¹í™”í•˜ì§€ë§Œ, **ëª…ì‹œì ìœ¼ë¡œ `DISTINCT`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ**
   - Neo4jì˜ `WITH` ì ˆì€ ì•”ì‹œì ìœ¼ë¡œ ê·¸ë£¹í™”í•˜ì§€ë§Œ, ë•Œë¡œëŠ” ì˜ˆìƒê³¼ ë‹¤ë¥´ê²Œ ë™ìž‘í•  ìˆ˜ ìžˆìŒ

2. **`max(r.stockRatio)`ì˜ ë™ìž‘**:
   - ì—¬ëŸ¬ ê´€ê³„ `r` ì¤‘ ìµœëŒ€ ì§€ë¶„ìœ¨ì„ ë°˜í™˜
   - í•˜ì§€ë§Œ ê°™ì€ ë…¸ë“œ `m`ì´ ì—¬ëŸ¬ ë²ˆ ë‚˜íƒ€ë‚  ìˆ˜ ìžˆëŠ” ê²½ìš°ê°€ ìžˆìŒ

3. **ê°€ëŠ¥í•œ ì¤‘ë³µ ì›ì¸**:
   - ê°™ì€ ë…¸ë“œ `m`ì— ëŒ€í•´ **ì–‘ë°©í–¥ ê´€ê³„**ê°€ ëª¨ë‘ ë§¤ì¹­ë¨ (`(n)-[r:HOLDS_SHARES]-(m)`)
   - `(n)-[:HOLDS_SHARES]->(m)`ì™€ `(n)<-[:HOLDS_SHARES]-(m)`ê°€ ëª¨ë‘ ë§¤ì¹­ë  ìˆ˜ ìžˆìŒ
   - ê° ë°©í–¥ì˜ ê´€ê³„ê°€ ë‹¤ë¥¸ `baseDate`/`reportYear`ë¥¼ ê°€ì§ˆ ìˆ˜ ìžˆìŒ

### ì‹¤ì œ ë°ì´í„° ì‹œë‚˜ë¦¬ì˜¤

**ê°€ëŠ¥í•œ ì‹œë‚˜ë¦¬ì˜¤**:
```
ë…¸ë“œ A (íšŒì‚¬)
  <-[:HOLDS_SHARES {stockRatio: 16.3, baseDate: 2020-01-01}]-(í•œì–‘í•™ì›)
  <-[:HOLDS_SHARES {stockRatio: 14.6, baseDate: 2021-01-01}]-(í•œì–‘í•™ì›)
```

**ë˜ëŠ”**:
```
ë…¸ë“œ A (í•œì–‘í•™ì›)
  -[:HOLDS_SHARES {stockRatio: 16.3, baseDate: 2020-01-01}]->(íšŒì‚¬ B)
  -[:HOLDS_SHARES {stockRatio: 14.6, baseDate: 2021-01-01}]->(íšŒì‚¬ B)
```

**í˜„ìž¬ ì¿¼ë¦¬ì˜ ë¬¸ì œ**:
- `WITH m`ì´ ë…¸ë“œë¥¼ ê·¸ë£¹í™”í•˜ì§€ë§Œ, **ì–‘ë°©í–¥ ê´€ê³„**ë¡œ ì¸í•´ ê°™ì€ ë…¸ë“œê°€ ì—¬ëŸ¬ ë²ˆ ë‚˜íƒ€ë‚  ìˆ˜ ìžˆìŒ
- ë˜ëŠ” `WITH m`ì´ ì œëŒ€ë¡œ ê·¸ë£¹í™”í•˜ì§€ ëª»í•˜ëŠ” ê²½ìš°ê°€ ìžˆì„ ìˆ˜ ìžˆìŒ

---

## í•´ê²° ë°©ì•ˆ

### í•´ê²°ì±… 1: DISTINCT ì‚¬ìš© (ê¶Œìž¥)

**ìˆ˜ì •ëœ ì¿¼ë¦¬**:
```cypher
MATCH (n)-[r:HOLDS_SHARES]-(m)
WHERE id(n) = $id
WITH DISTINCT m, labels(m) AS labels, properties(m) AS props, max(r.stockRatio) AS ratio
RETURN id(m) AS id, labels, props, ratio
ORDER BY ratio DESC
LIMIT 20
```

**ê°œì„ ì **:
- âœ… `DISTINCT m`ì„ ëª…ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œ ì¤‘ë³µ ì œê±°
- âœ… `max(r.stockRatio)`ëŠ” ì—¬ëŸ¬ ê´€ê³„ ì¤‘ ìµœëŒ€ê°’ ë°˜í™˜
- âœ… ê°„ë‹¨í•˜ê³  ëª…í™•í•œ í•´ê²°ì±…

### í•´ê²°ì±… 2: ë…¸ë“œ IDë¡œ ëª…ì‹œì  ê·¸ë£¹í™”

**ìˆ˜ì •ëœ ì¿¼ë¦¬**:
```cypher
MATCH (n)-[r:HOLDS_SHARES]-(m)
WHERE id(n) = $id
WITH id(m) AS mId, m, labels(m) AS labels, properties(m) AS props, collect(r.stockRatio) AS ratios
WITH mId, m, labels, props, max(ratios) AS ratio
RETURN id(m) AS id, labels, props, ratio
ORDER BY ratio DESC
LIMIT 20
```

**ê°œì„ ì **:
- âœ… `id(m)`ìœ¼ë¡œ ëª…ì‹œì  ê·¸ë£¹í™”
- âœ… `collect(r.stockRatio)`ë¡œ ëª¨ë“  ì§€ë¶„ìœ¨ ìˆ˜ì§‘ í›„ `max()` ì ìš©
- âœ… ë” ëª…ì‹œì ì´ì§€ë§Œ ë³µìž¡í•¨

### í•´ê²°ì±… 3: ì–‘ë°©í–¥ ê´€ê³„ ëª…ì‹œ (ê°€ìž¥ ì•ˆì „)

**ìˆ˜ì •ëœ ì¿¼ë¦¬**:
```cypher
MATCH (n)-[r1:HOLDS_SHARES]->(m)
WHERE id(n) = $id
WITH DISTINCT m, labels(m) AS labels, properties(m) AS props, max(r1.stockRatio) AS ratio1
OPTIONAL MATCH (n)<-[r2:HOLDS_SHARES]-(m)
WITH m, labels, props, ratio1, max(r2.stockRatio) AS ratio2
WITH m, labels, props, coalesce(ratio1, 0) AS r1, coalesce(ratio2, 0) AS r2
WITH m, labels, props, max([r1, r2]) AS ratio
RETURN id(m) AS id, labels, props, ratio
ORDER BY ratio DESC
LIMIT 20
```

**ê°œì„ ì **:
- âœ… ì–‘ë°©í–¥ ê´€ê³„ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì²˜ë¦¬
- âœ… ê° ë°©í–¥ì˜ ìµœëŒ€ê°’ì„ êµ¬í•œ í›„ ì „ì²´ ìµœëŒ€ê°’ ë°˜í™˜
- âœ… ê°€ìž¥ ì•ˆì „í•˜ì§€ë§Œ ë³µìž¡í•¨

---

## í˜¸í™˜ì„± ê²€í† 

### Neo4j í˜¸í™˜ì„±

**í™•ì¸ ì‚¬í•­**:
- `DISTINCT`: âœ… Neo4j 1.0+ ì§€ì›
- `WITH` ì ˆ ê·¸ë£¹í™”: âœ… Neo4j 1.0+ ì§€ì›
- `collect()` + `max()`: âœ… Neo4j 1.0+ ì§€ì›

**ê²°ê³¼**: âœ… ëª¨ë“  Neo4j ë²„ì „ì—ì„œ í˜¸í™˜

---

## ì¼ê´€ì„± ê²€í† 

### ê¸°ì¡´ ì½”ë“œì™€ì˜ ì¼ê´€ì„±

**ê¸°ì¡´ íŒ¨í„´** (`backend/app/api/v1/endpoints/graph.py:487`):
```cypher
WITH DISTINCT s, max(r.stockRatio) AS maxRatio
```
- âœ… `DISTINCT`ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì‚¬ìš©

**ìˆ˜ì •ëœ íŒ¨í„´**:
```cypher
WITH DISTINCT m, labels(m) AS labels, properties(m) AS props, max(r.stockRatio) AS ratio
```
- âœ… ê¸°ì¡´ íŒ¨í„´ê³¼ ì¼ê´€ì„± ìœ ì§€

**ê²°ê³¼**: âœ… ì¼ê´€ì„± í–¥ìƒ

---

## ìœ ì§€ë³´ìˆ˜ì„± ê²€í† 

### ì¿¼ë¦¬ ê°€ë…ì„±

**ê°œì„  ì‚¬í•­**:
- `DISTINCT`ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ì˜ë„ ëª…í™•í™”
- ì¤‘ë³µ ì œê±° ë¡œì§ì´ ëª…í™•í•¨

**ê²°ê³¼**: âœ… ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ

---

## í™•ìž¥ì„± ê²€í† 

### ë‹¤ë¥¸ ì¿¼ë¦¬ì— ì ìš© ê°€ëŠ¥

**ê°œì„  ì‚¬í•­**:
- `DISTINCT` íŒ¨í„´ì€ ë‹¤ë¥¸ ì¿¼ë¦¬ì—ë„ ì ìš© ê°€ëŠ¥
- ë…¸ë“œ ì¤‘ë³µ ì œê±°ê°€ í•„ìš”í•œ ëª¨ë“  ì¿¼ë¦¬ì— ì ìš© ê°€ëŠ¥

**ê²°ê³¼**: âœ… í™•ìž¥ì„± í–¥ìƒ

---

## í˜‘ì—… ì½”ë“œ ê²€í† 

### ë¬¸ì„œí™”

**ê°œì„  ì‚¬í•­**:
- `DISTINCT` ì‚¬ìš© ì´ìœ  ëª…í™•í™”
- ì¤‘ë³µ ì œê±° ë¡œì§ ë¬¸ì„œí™”

**ê²°ê³¼**: âœ… í˜‘ì—… ì½”ë“œ í’ˆì§ˆ í–¥ìƒ

---

## ê¶Œìž¥ ì‚¬í•­

### P0 - Critical (ì¦‰ì‹œ ê°œì„ )

1. **`DISTINCT` ëª…ì‹œì  ì‚¬ìš©**
   - `WITH DISTINCT m`ìœ¼ë¡œ ë³€ê²½
   - ë…¸ë“œ ì¤‘ë³µ ì œê±° ë³´ìž¥

2. **ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸**
   - ê°™ì€ ë…¸ë“œê°€ ì—¬ëŸ¬ ë²ˆ ë‚˜íƒ€ë‚˜ëŠ”ì§€ í™•ì¸
   - `baseDate`/`reportYear`ê°€ ë‹¤ë¥¸ ê²½ìš°ì—ë„ ì¤‘ë³µì´ ì œê±°ë˜ëŠ”ì§€ í™•ì¸

### P1 - High (ë‹¨ê¸° ê°œì„ )

3. **ì–‘ë°©í–¥ ê´€ê³„ ëª…ì‹œ (ì„ íƒì‚¬í•­)**
   - í•„ìš”ì‹œ ì–‘ë°©í–¥ ê´€ê³„ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì²˜ë¦¬
   - ë” ì•ˆì „í•˜ì§€ë§Œ ë³µìž¡í•¨

---

## ðŸ“Š ê°œì„  íš¨ê³¼ ìš”ì•½

### ë¬¸ì œ í•´ê²°

**Before**:
- âŒ ê°™ì€ ë…¸ë“œê°€ ì—¬ëŸ¬ ë²ˆ ë‚˜íƒ€ë‚¨ (ì˜ˆ: í•œì–‘í•™ì› 16.3%, 14.6%)
- âŒ `WITH m`ì´ ì œëŒ€ë¡œ ê·¸ë£¹í™”í•˜ì§€ ëª»í•¨
- âŒ ì‚¬ìš©ìž í˜¼ëž€

**After**:
- âœ… `DISTINCT`ë¡œ ë…¸ë“œ ì¤‘ë³µ ì œê±°
- âœ… ê° ë…¸ë“œëŠ” í•œ ë²ˆë§Œ ë‚˜íƒ€ë‚¨
- âœ… `max(r.stockRatio)`ë¡œ ìµœëŒ€ ì§€ë¶„ìœ¨ í‘œì‹œ

### ì½”ë“œ í’ˆì§ˆ

**Before**:
- âš ï¸ ì•”ì‹œì  ê·¸ë£¹í™”ì— ì˜ì¡´
- âš ï¸ ì¤‘ë³µ ì œê±° ë¡œì§ ë¶ˆëª…í™•

**After**:
- âœ… ëª…ì‹œì  `DISTINCT` ì‚¬ìš©
- âœ… ì¤‘ë³µ ì œê±° ë¡œì§ ëª…í™•í™”
- âœ… ê¸°ì¡´ ì½”ë“œì™€ ì¼ê´€ì„± ìœ ì§€

---

## ðŸ” ë³€ê²½ëœ íŒŒì¼

### ë°±ì—”ë“œ
- `backend/app/api/v1/endpoints/graph.py`:
  - `related_query` ìˆ˜ì • (`WITH DISTINCT m` ì¶”ê°€)

### ë¬¸ì„œ
- `docs/CTO-DUPLICATE-NODES-REVIEW.md`: ë³¸ ë¬¸ì„œ

---

## âœ… í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] ê°™ì€ ë…¸ë“œê°€ ì—¬ëŸ¬ ë²ˆ ë‚˜íƒ€ë‚˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸
- [ ] `baseDate`/`reportYear`ê°€ ë‹¤ë¥¸ ê²½ìš°ì—ë„ ì¤‘ë³µì´ ì œê±°ë˜ëŠ”ì§€ í™•ì¸
- [ ] `max(r.stockRatio)`ê°€ ì˜¬ë°”ë¥´ê²Œ ìž‘ë™í•˜ëŠ”ì§€ í™•ì¸
- [ ] ì–‘ë°©í–¥ ê´€ê³„ê°€ ìžˆëŠ” ê²½ìš°ì—ë„ ì •ìƒ ìž‘ë™í•˜ëŠ”ì§€ í™•ì¸

---

## ê´€ë ¨ ë¬¸ì„œ

- `docs/CTO-SHAREHOLDER-COUNT-REVIEW.md`: ì£¼ì£¼ ìˆ˜ ê³„ì‚° ê´€ë ¨ ë¬¸ì„œ
- `docs/NEO4J-EXPERT-FIXES.md`: Neo4j ì „ë¬¸ê°€ ìˆ˜ì • ì‚¬í•­ ë¬¸ì„œ
- `docs/CTO-DUPLICATE-NODES-REVIEW.md`: ë³¸ ë¬¸ì„œ
