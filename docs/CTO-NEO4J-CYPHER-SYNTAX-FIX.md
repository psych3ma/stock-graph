# CTO: Neo4j Cypher êµ¬ë¬¸ ì˜¤ë¥˜ ìˆ˜ì •

**ê²€í† ìž**: ê·¸ëž˜í”„ DB ì „ë¬¸ê°€ ì¶œì‹  CTO  
**ìž‘ì—… ì¼ìž**: 2026-02-19  
**ê²€í†  ê¸°ì¤€**: í˜¸í™˜ì„±, ì¼ê´€ì„±, ìœ ì§€ë³´ìˆ˜ì„±, í™•ìž¥ì„±, í˜‘ì—… ì½”ë“œ

---

## ðŸ“‹ ë¬¸ì œ ë¶„ì„

### ì—ëŸ¬ ë©”ì‹œì§€

```
Neo.ClientError.Statement.SyntaxError
Parameter maps can...
```

**ìš”ì²­ URL**: `/api/v1/graph/ego?node_id=n204&max_hops=2&max_nodes=120`  
**HTTP ìƒíƒœ**: 500 (Internal Server Error)  
**ì—ëŸ¬ ìœ„ì¹˜**: `backend/app/api/v1/endpoints/graph.py:594-595`

### ê·¼ë³¸ ì›ì¸

**Neo4j Cypher ì œí•œì‚¬í•­**:
- Neo4jëŠ” ê´€ê³„ íŒ¨í„´ ê¸¸ì´(variable-length patterns)ì—ì„œ **íŒŒë¼ë¯¸í„°ë¥¼ ì§ì ‘ ì§€ì›í•˜ì§€ ì•ŠìŒ**
- `*1..$max_hops` ê°™ì€ íŒŒë¼ë¯¸í„° ì‚¬ìš© ë¶ˆê°€
- `*1..3` ê°™ì€ ë¦¬í„°ëŸ´ ê°’ë§Œ í—ˆìš©ë¨

**ë¬¸ì œ ì½”ë“œ**:
```cypher
OPTIONAL MATCH (ego)-[r1:HOLDS_SHARES*1..$max_hops]->(n1)
OPTIONAL MATCH (ego)<-[r2:HOLDS_SHARES*1..$max_hops]-(n2)
```

**ë¬¸ì œì **:
- `$max_hops` íŒŒë¼ë¯¸í„°ë¥¼ ê´€ê³„ íŒ¨í„´ ê¸¸ì´ì— ì§ì ‘ ì‚¬ìš© ì‹œë„
- Neo4jê°€ ì´ë¥¼ êµ¬ë¬¸ ì˜¤ë¥˜ë¡œ ì¸ì‹

---

## í•´ê²° ë°©ì•ˆ

### ì„ íƒëœ í•´ê²°ì±…: ë™ì  ì¿¼ë¦¬ ìƒì„±

**ì´ìœ **:
- Neo4j ê³µì‹ ë¬¸ì„œì— ë”°ë¥´ë©´ ê´€ê³„ íŒ¨í„´ ê¸¸ì´ëŠ” ë¦¬í„°ëŸ´ ê°’ë§Œ í—ˆìš©
- `max_hops`ëŠ” ì´ë¯¸ 1~3 ë²”ìœ„ë¡œ ì œí•œë˜ì–´ ìžˆì–´ ë³´ì•ˆ ìœ„í—˜ ë‚®ìŒ
- ë‹¤ë¥¸ ëŒ€ì•ˆ(APOC í”„ë¡œì‹œì € ë“±)ì€ ì¶”ê°€ ì˜ì¡´ì„± í•„ìš”

**êµ¬í˜„**:
```python
max_hops_clamped = max(1, min(3, max_hops))

# f-stringìœ¼ë¡œ ë¦¬í„°ëŸ´ ê°’ ì‚½ìž… (ë³´ì•ˆ: max_hops_clampedëŠ” 1~3 ë²”ìœ„ë¡œ ì œí•œë¨)
nodes_query = f"""
    MATCH (ego)
    WHERE id(ego) = $id
    OPTIONAL MATCH (ego)-[r1:HOLDS_SHARES*1..{max_hops_clamped}]->(n1)
    OPTIONAL MATCH (ego)<-[r2:HOLDS_SHARES*1..{max_hops_clamped}]-(n2)
    WITH ego, n1, n2
    UNWIND [n1, n2, ego] AS n
    WITH n WHERE n IS NOT NULL
    WITH DISTINCT n
    LIMIT $max_nodes
    RETURN id(n) AS id, labels(n) AS labels, properties(n) AS props
"""

rows = graph.query(
    nodes_query, 
    params={"id": neo4j_id, "max_nodes": max_nodes}  # max_hops ì œê±°
)
```

---

## ë³´ì•ˆ ê²€í† 

### ìž ìž¬ì  ë³´ì•ˆ ìœ„í—˜

**f-string ì‚¬ìš©**:
- `max_hops_clamped` ê°’ì´ ì¿¼ë¦¬ì— ì§ì ‘ ì‚½ìž…ë¨
- SQL Injectionê³¼ ìœ ì‚¬í•œ Cypher Injection ìœ„í—˜ ê°€ëŠ¥ì„±

**ì™„í™” ì¡°ì¹˜**:
1. **ìž…ë ¥ ê²€ì¦**: `max_hops`ëŠ” ì´ë¯¸ `Query(2, ge=1, le=3)`ë¡œ ì œí•œë¨
2. **ê°’ í´ëž¨í•‘**: `max_hops_clamped = max(1, min(3, max_hops))`ë¡œ ì´ì¤‘ ê²€ì¦
3. **ì œí•œëœ ë²”ìœ„**: 1~3 ë²”ìœ„ë§Œ í—ˆìš©ë˜ì–´ ì•…ì˜ì  ê°’ ì‚½ìž… ë¶ˆê°€ëŠ¥
4. **íƒ€ìž… ê²€ì¦**: FastAPIê°€ `int` íƒ€ìž…ìœ¼ë¡œ ê²€ì¦

**ê²°ë¡ **: âœ… ë³´ì•ˆ ìœ„í—˜ ë‚®ìŒ (ìž…ë ¥ ê²€ì¦ ë° ë²”ìœ„ ì œí•œìœ¼ë¡œ ì™„í™”)

---

## í˜¸í™˜ì„± ê²€í† 

### Neo4j ë²„ì „ í˜¸í™˜ì„±

**í™•ì¸ ì‚¬í•­**:
- Neo4j 4.x+: âœ… ì§€ì› (variable-length patterns ì§€ì›)
- Neo4j 5.x+: âœ… ì§€ì› (ë™ì¼)
- Neo4j 3.x: âš ï¸ í™•ì¸ í•„ìš” (í•˜ì§€ë§Œ í˜„ìž¬ í”„ë¡œì íŠ¸ëŠ” 5.x ì‚¬ìš©)

**ê²°ê³¼**: âœ… í˜¸í™˜ì„± ìœ ì§€

### API í˜¸í™˜ì„±

**í™•ì¸ ì‚¬í•­**:
- ê¸°ì¡´ API ì—”ë“œí¬ì¸íŠ¸ ìœ ì§€ (`/api/v1/graph/ego`)
- ìš”ì²­ íŒŒë¼ë¯¸í„° ìœ ì§€ (`node_id`, `max_hops`, `max_nodes`)
- ì‘ë‹µ í˜•ì‹ ìœ ì§€ (`nodes`, `edges`, `ego_id`)

**ê²°ê³¼**: âœ… API í˜¸í™˜ì„± ìœ ì§€

---

## ì¼ê´€ì„± ê²€í† 

### ì½”ë“œ íŒ¨í„´ ì¼ê´€ì„±

**ê¸°ì¡´ íŒ¨í„´**:
- ë‹¤ë¥¸ ì¿¼ë¦¬ë“¤ì€ ëŒ€ë¶€ë¶„ íŒŒë¼ë¯¸í„°í™”ëœ ì¿¼ë¦¬ ì‚¬ìš©
- f-string ì‚¬ìš©ì€ ì´ ì¿¼ë¦¬ì—ì„œë§Œ í•„ìš” (Neo4j ì œí•œì‚¬í•­)

**ê°œì„  ì‚¬í•­**:
- ì£¼ì„ìœ¼ë¡œ f-string ì‚¬ìš© ì´ìœ  ëª…ì‹œ
- ë³´ì•ˆ ê²€ì¦ ë¡œì§ ëª…ì‹œ
- ë‹¤ë¥¸ ê°œë°œìžê°€ ì´í•´í•˜ê¸° ì‰½ë„ë¡ ë¬¸ì„œí™”

**ê²°ê³¼**: âœ… ì¼ê´€ì„± ìœ ì§€ (ì œí•œì‚¬í•­ìœ¼ë¡œ ì¸í•œ ì˜ˆì™¸ëŠ” ë¬¸ì„œí™”)

---

## ìœ ì§€ë³´ìˆ˜ì„± ê²€í† 

### ì½”ë“œ ê°€ë…ì„±

**ê°œì„  ì‚¬í•­**:
- ì£¼ì„ìœ¼ë¡œ Neo4j ì œí•œì‚¬í•­ ëª…ì‹œ
- ë³´ì•ˆ ê²€ì¦ ë¡œì§ ëª…ì‹œ
- f-string ì‚¬ìš© ì´ìœ  ëª…ì‹œ

**ê²°ê³¼**: âœ… ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ

### í…ŒìŠ¤íŠ¸ ìš©ì´ì„±

**ê°œì„  ì‚¬í•­**:
- `max_hops` ê°’ì— ë”°ë¼ ì¿¼ë¦¬ê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë¨
- ê° ê°’(1, 2, 3)ì— ëŒ€í•´ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥

**ê²°ê³¼**: âœ… í…ŒìŠ¤íŠ¸ ìš©ì´ì„± í–¥ìƒ

---

## í™•ìž¥ì„± ê²€í† 

### í˜„ìž¬ ì œí•œì‚¬í•­

**ì œí•œ**:
- `max_hops`ëŠ” 1~3 ë²”ìœ„ë¡œ ì œí•œë¨
- ë” í° ê°’ì´ í•„ìš”í•œ ê²½ìš° ì½”ë“œ ìˆ˜ì • í•„ìš”

**í™•ìž¥ ë°©ì•ˆ**:
- í•„ìš” ì‹œ `max_hops` ë²”ìœ„ í™•ëŒ€ ê°€ëŠ¥
- í•˜ì§€ë§Œ ì„±ëŠ¥ ê³ ë ¤ í•„ìš” (ê´€ê³„ íŒ¨í„´ ê¸¸ì´ê°€ ê¸¸ìˆ˜ë¡ ì¿¼ë¦¬ ë¹„ìš© ì¦ê°€)

**ê²°ê³¼**: âœ… í™•ìž¥ ê°€ëŠ¥ (ì„±ëŠ¥ ê³ ë ¤ í•„ìš”)

---

## í˜‘ì—… ì½”ë“œ ê²€í† 

### ë¬¸ì„œí™”

**ê°œì„  ì‚¬í•­**:
- ì£¼ì„ìœ¼ë¡œ Neo4j ì œí•œì‚¬í•­ ëª…ì‹œ
- f-string ì‚¬ìš© ì´ìœ  ëª…ì‹œ
- ë³´ì•ˆ ê²€ì¦ ë¡œì§ ëª…ì‹œ

**ê²°ê³¼**: âœ… í˜‘ì—… ì½”ë“œ í’ˆì§ˆ í–¥ìƒ

### ì½”ë“œ ë¦¬ë·° ìš©ì´ì„±

**ê°œì„  ì‚¬í•­**:
- ëª…í™•í•œ ì£¼ì„ìœ¼ë¡œ ë¦¬ë·°ì–´ê°€ ì´í•´í•˜ê¸° ì‰¬ì›€
- ë³´ì•ˆ ê²€ì¦ ë¡œì§ì´ ëª…ì‹œì ìœ¼ë¡œ ë³´ìž„

**ê²°ê³¼**: âœ… ì½”ë“œ ë¦¬ë·° ìš©ì´ì„± í–¥ìƒ

---

## ëŒ€ì•ˆ ê²€í† 

### ëŒ€ì•ˆ 1: APOC í”„ë¡œì‹œì € ì‚¬ìš©

**ë°©ë²•**:
```cypher
CALL apoc.path.expandConfig(ego, {
    relationshipFilter: 'HOLDS_SHARES>',
    minLevel: 1,
    maxLevel: $max_hops
}) YIELD path
```

**ìž¥ì **:
- íŒŒë¼ë¯¸í„° ì‚¬ìš© ê°€ëŠ¥
- ë” ìœ ì—°í•œ ì˜µì…˜ ì œê³µ

**ë‹¨ì **:
- APOC ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜ì¡´ì„± í•„ìš”
- ì¶”ê°€ ì„¤ì¹˜ ë° ì„¤ì • í•„ìš”
- í˜„ìž¬ í”„ë¡œì íŠ¸ì— APOC ì„¤ì¹˜ ì—¬ë¶€ ë¶ˆëª…í™•

**ê²°ë¡ **: âŒ í˜„ìž¬ í”„ë¡œì íŠ¸ì— ì ìš©í•˜ê¸° ì–´ë ¤ì›€

### ëŒ€ì•ˆ 2: UNION ì‚¬ìš©

**ë°©ë²•**:
```cypher
MATCH (ego) WHERE id(ego) = $id
OPTIONAL MATCH (ego)-[r1:HOLDS_SHARES*1..1]->(n1)
WITH ego, collect(DISTINCT n1) AS nodes1
OPTIONAL MATCH (ego)-[r2:HOLDS_SHARES*1..2]->(n2)
WITH ego, nodes1, collect(DISTINCT n2) AS nodes2
...
```

**ìž¥ì **:
- íŒŒë¼ë¯¸í„°í™”ëœ ì¿¼ë¦¬ ì‚¬ìš© ê°€ëŠ¥

**ë‹¨ì **:
- ì¿¼ë¦¬ ë³µìž¡ë„ ì¦ê°€
- ì„±ëŠ¥ ì €í•˜ ê°€ëŠ¥ì„±
- ì½”ë“œ ê°€ë…ì„± ì €í•˜

**ê²°ë¡ **: âŒ ë³µìž¡ë„ ì¦ê°€ë¡œ ì¸í•´ ë¹„ê¶Œìž¥

### ëŒ€ì•ˆ 3: ë™ì  ì¿¼ë¦¬ ìƒì„± (ì„ íƒë¨)

**ë°©ë²•**:
- f-stringìœ¼ë¡œ ë¦¬í„°ëŸ´ ê°’ ì‚½ìž…
- ìž…ë ¥ ê²€ì¦ ë° ë²”ìœ„ ì œí•œ

**ìž¥ì **:
- ì¶”ê°€ ì˜ì¡´ì„± ì—†ìŒ
- ì½”ë“œ ê°„ê²°ì„± ìœ ì§€
- ì„±ëŠ¥ ì˜í–¥ ì—†ìŒ

**ë‹¨ì **:
- f-string ì‚¬ìš© (ë³´ì•ˆ ê²€ì¦ í•„ìš”)

**ê²°ë¡ **: âœ… ìµœì ì˜ í•´ê²°ì±… (ìž…ë ¥ ê²€ì¦ìœ¼ë¡œ ë³´ì•ˆ ì™„í™”)

---

## ì ìš©ëœ ìˆ˜ì • ì‚¬í•­

### ë³€ê²½ ì „

```python
nodes_query = """
    MATCH (ego)
    WHERE id(ego) = $id
    OPTIONAL MATCH (ego)-[r1:HOLDS_SHARES*1..$max_hops]->(n1)
    OPTIONAL MATCH (ego)<-[r2:HOLDS_SHARES*1..$max_hops]-(n2)
    ...
"""
rows = graph.query(
    nodes_query, 
    params={"id": neo4j_id, "max_hops": max_hops_clamped, "max_nodes": max_nodes}
)
```

### ë³€ê²½ í›„

```python
max_hops_clamped = max(1, min(3, max_hops))

# CTO: ê´€ê³„ íŒ¨í„´ ê¸¸ì´ëŠ” ë¦¬í„°ëŸ´ ê°’ë§Œ í—ˆìš©ë˜ë¯€ë¡œ ë™ì  ì¿¼ë¦¬ ìƒì„± í•„ìš”
# ë³´ì•ˆ: max_hops_clampedëŠ” ì´ë¯¸ 1~3 ë²”ìœ„ë¡œ ì œí•œë˜ì–´ ìžˆìŒ
nodes_query = f"""
    MATCH (ego)
    WHERE id(ego) = $id
    OPTIONAL MATCH (ego)-[r1:HOLDS_SHARES*1..{max_hops_clamped}]->(n1)
    OPTIONAL MATCH (ego)<-[r2:HOLDS_SHARES*1..{max_hops_clamped}]-(n2)
    ...
"""
rows = graph.query(
    nodes_query, 
    params={"id": neo4j_id, "max_nodes": max_nodes}  # max_hops ì œê±°
)
```

---

## ðŸ“Š ê°œì„  íš¨ê³¼ ìš”ì•½

### ë¬¸ì œ í•´ê²°

**Before**:
- âŒ `Neo.ClientError.Statement.SyntaxError` ë°œìƒ
- âŒ Ego ê·¸ëž˜í”„ ë¡œë“œ ì‹¤íŒ¨
- âŒ ì§€ë°°êµ¬ì¡° ë§µ ë³´ê¸° ê¸°ëŠ¥ ìž‘ë™ ë¶ˆê°€

**After**:
- âœ… Cypher êµ¬ë¬¸ ì˜¤ë¥˜ í•´ê²°
- âœ… Ego ê·¸ëž˜í”„ ì •ìƒ ë¡œë“œ
- âœ… ì§€ë°°êµ¬ì¡° ë§µ ë³´ê¸° ê¸°ëŠ¥ ì •ìƒ ìž‘ë™

### ì½”ë“œ í’ˆì§ˆ

**Before**:
- âš ï¸ Neo4j ì œí•œì‚¬í•­ ë¯¸ê³ ë ¤
- âš ï¸ íŒŒë¼ë¯¸í„° ì‚¬ìš© ì‹œë„ (ì§€ì›ë˜ì§€ ì•ŠìŒ)

**After**:
- âœ… Neo4j ì œí•œì‚¬í•­ ê³ ë ¤
- âœ… ë™ì  ì¿¼ë¦¬ ìƒì„±ìœ¼ë¡œ í•´ê²°
- âœ… ë³´ì•ˆ ê²€ì¦ ê°•í™”

---

## ðŸ” ë³€ê²½ëœ íŒŒì¼

### ë°±ì—”ë“œ
- `backend/app/api/v1/endpoints/graph.py`: `get_ego_graph()` í•¨ìˆ˜ ìˆ˜ì • (ë¼ì¸ 585-607)

### ë¬¸ì„œ
- `docs/CTO-NEO4J-CYPHER-SYNTAX-FIX.md`: ë³¸ ë¬¸ì„œ

---

## âœ… í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] `max_hops=1`ë¡œ Ego ê·¸ëž˜í”„ ë¡œë“œ í™•ì¸
- [ ] `max_hops=2`ë¡œ Ego ê·¸ëž˜í”„ ë¡œë“œ í™•ì¸
- [ ] `max_hops=3`ë¡œ Ego ê·¸ëž˜í”„ ë¡œë“œ í™•ì¸
- [ ] `max_hops` ë²”ìœ„ ë°– ê°’(0, 4) ìž…ë ¥ ì‹œ í´ëž¨í•‘ í™•ì¸
- [ ] Cypher êµ¬ë¬¸ ì˜¤ë¥˜ ì—†ìŒ í™•ì¸
- [ ] ì§€ë°°êµ¬ì¡° ë§µ ë³´ê¸° ê¸°ëŠ¥ ì •ìƒ ìž‘ë™ í™•ì¸

---

## ê´€ë ¨ ë¬¸ì„œ

- `docs/CTO-GOVERNANCE-MAP-FIX.md`: ì´ˆê¸° ìˆ˜ì • ì‚¬í•­ ë¬¸ì„œ
- `docs/CTO-GOVERNANCE-MAP-CODE-REVIEW.md`: ì½”ë“œ ê²€í†  ë¬¸ì„œ
- `docs/CTO-NEO4J-CYPHER-SYNTAX-FIX.md`: ë³¸ ë¬¸ì„œ
