# CTO Fix: 프롬프트 엔지니어링 & 그래프DB 개선 적용

**검토자**: 프롬프트 엔지니어링 + 그래프DB 전문가 출신 CTO  
**작업 일자**: 2026-02-19  
**검토 기준**: 호환성, 일관성, 유지보수성, 확장성, 협업 코드

---

## 📋 적용된 수정 사항

### 1. Cypher 프롬프트 개선 (그래프DB 전문가 관점)

**수정 전**:
```cypher
WITH s, c, collect({{ratio: r.stockRatio, date: r.baseDate, year: r.reportYear}}) AS ratios
RETURN s.stockName, c.companyName, ratios
```

**문제점**:
- ❌ 중첩 구조로 LLM 파싱 어려움
- ❌ 연도별 정렬 보장 안 됨

**수정 후**:
```cypher
WITH s, c, r ORDER BY r.reportYear ASC, r.baseDate ASC
WITH s, c, collect(r.reportYear) AS years, collect(r.stockRatio) AS ratios
RETURN s.stockName, c.companyName, years, ratios
ORDER BY years[0] ASC
```

**개선점**:
- ✅ `years`, `ratios`를 별도 리스트로 반환 (파싱 용이)
- ✅ `ORDER BY`로 시간순 정렬 보장
- ✅ LLM이 파싱하기 쉬운 평면 구조

### 2. QA_PROMPT 개선 (프롬프트 엔지니어링 관점)

**수정 전**:
```
[답변 규칙]
- 핵심 수치(지분율·금액·건수) 먼저
- 결과가 있으면 4줄 이내 간결하게 답변
```

**문제점**:
- ❌ Few-shot 예시 부재
- ❌ 출력 형식 명시 부재
- ❌ 시계열 데이터 처리 가이드라인 부재

**수정 후**:
```
[시계열 데이터 답변 형식]
- DB 결과에 years, ratios 배열이 있으면:
  - 형식: "2020년 15%, 2021년 16%" (연도별 지분율)
  - 시간순으로 정렬하여 표시
  - 예시:
    * 입력: years: [2020, 2021], ratios: [15.0, 16.0]
    * 출력: "2020년 15%, 2021년 16%"

- 추상적인 설명 대신 구체적인 수치 우선 표시
- 시계열 정보가 있으면 반드시 연도별로 표시

[답변 형식]
- 시계열 데이터: "x0년 y0%, x1년 y1%" 형식 필수
```

**개선점**:
- ✅ Few-shot 예시 추가 (입력→출력 매핑)
- ✅ 출력 형식 명시 ("x0년 y0%, x1년 y1%")
- ✅ 구조화된 데이터 처리 가이드라인
- ✅ 추상적 설명 금지, 구체적 수치 우선

---

## 호환성 검토

### Neo4j 호환성

**확인 사항**:
- `collect()` 함수: ✅ Neo4j 1.0+ 지원
- `ORDER BY`: ✅ Neo4j 1.0+ 지원
- 리스트 인덱싱 `years[0]`: ✅ Neo4j 3.0+ 지원

**결과**: ✅ 모든 Neo4j 버전에서 호환

### LangChain 호환성

**확인 사항**:
- 프롬프트 수정만으로 해결
- `GraphCypherQAChain`의 동작에 영향 없음

**결과**: ✅ 호환성 유지

---

## 일관성 검토

### 쿼리 패턴 일관성

**개선 사항**:
- 모든 시계열 쿼리에서 `years`, `ratios`를 별도 리스트로 반환
- `ORDER BY` 패턴 일관성 유지

**결과**: ✅ 일관성 향상

### 답변 형식 일관성

**개선 사항**:
- 시계열 데이터에 대한 일관된 포맷팅 규칙
- Few-shot 예시로 형식 명확화

**결과**: ✅ 일관성 향상

---

## 유지보수성 검토

### 프롬프트 관리

**개선 사항**:
- Few-shot 예시로 의도 명확화
- 출력 형식 규칙 명시로 유지보수 용이

**결과**: ✅ 유지보수성 향상

### 쿼리 가독성

**개선 사항**:
- 평면 구조로 파싱 용이
- `ORDER BY` 명시로 의도 명확화

**결과**: ✅ 유지보수성 향상

---

## 확장성 검토

### 다른 시계열 질문에 적용 가능

**개선 사항**:
- 시계열 데이터 포맷팅 규칙은 다른 질문 유형에도 적용 가능
- Few-shot 예시 패턴 재사용 가능

**결과**: ✅ 확장성 향상

### 새로운 쿼리 패턴 추가

**개선 사항**:
- 쿼리 예시 패턴이 명확하여 새로운 패턴 추가 용이
- LLM이 예시를 참고하여 유사한 쿼리 생성 가능

**결과**: ✅ 확장성 향상

---

## 협업 코드 검토

### 문서화

**개선 사항**:
- Few-shot 예시로 다른 개발자가 이해하기 쉬움
- 출력 형식 규칙 명시로 협업 용이

**결과**: ✅ 협업 코드 품질 향상

---

## 📊 개선 효과 요약

### 문제 해결

**Before**:
- ❌ "데이터 중복으로 보입니다" 같은 추상적인 답변
- ❌ 구체적인 수치(연도별 지분율) 미제시
- ❌ 중첩 구조로 LLM 파싱 어려움

**After**:
- ✅ "2020년 15%, 2021년 16%" 같은 구체적인 답변
- ✅ 연도별 지분율을 명확히 표시
- ✅ 평면 구조로 LLM 파싱 용이

### 코드 품질

**Before**:
- ⚠️ 시계열 데이터 포맷팅 가이드라인 부재
- ⚠️ 중첩 구조로 파싱 어려움

**After**:
- ✅ 시계열 데이터 포맷팅 규칙 명시
- ✅ 평면 구조로 파싱 용이
- ✅ Few-shot 예시로 형식 명확화

---

## 🔍 변경된 파일

### 백엔드
- `backend/app/services/graph_service.py`:
  - `CYPHER_PROMPT` 개선 (시계열 쿼리 예시 수정)
  - `QA_PROMPT` 개선 (Few-shot 예시 + 출력 형식 명시 추가)

### 문서
- `docs/CTO-PROMPT-GRAPHDB-REVIEW.md`: 초기 검토 문서
- `docs/CTO-PROMPT-GRAPHDB-FIX.md`: 본 문서

---

## ✅ 테스트 체크리스트

- [ ] 시계열 질문에 "x0년 y0%, x1년 y1%" 형식 답변 생성 확인
- [ ] DB 결과에 `years`, `ratios`가 있을 때 연도별 표시 확인
- [ ] 추상적인 설명 대신 구체적인 수치 우선 표시 확인
- [ ] Cypher 쿼리가 시계열 데이터를 올바르게 반환하는지 확인
- [ ] 시간순 정렬이 보장되는지 확인

---

## 관련 문서

- `docs/CTO-AI-ANSWER-FORMAT-REVIEW.md`: 초기 답변 형식 문제 분석
- `docs/CTO-LANGCHAIN-EXPERT-REVIEW.md`: LangChain 전문가 검토
- `docs/CTO-PROMPT-GRAPHDB-REVIEW.md`: 초기 검토 문서
- `docs/CTO-PROMPT-GRAPHDB-FIX.md`: 본 문서
