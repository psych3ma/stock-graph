# CTO 검토: 초기 배치·물리 엔진·4군데 뭉침 해소

**문제**: 노드가 4군데에만 몰려 보이고, 사용자가 일일이 드래그해야만 분리됨.

**근본 원인 (3가지)**  
1. **초기값 부재**: "이 노드는 어디에 둘지"를 격자/기본값(100, 100) 수준으로만 정해 한 점에 몰림.  
2. **물리 엔진이 “실시간 퍼뜨리기”에 기여하지 못함**: 링크 힘이 컴포넌트 중심으로 당겨서, 반발만으로는 퍼지지 않고 뭉침이 유지됨.  
3. **충돌 감지만으로는 부족**: 처음 배치가 한 점에 모여 있으면, 충돌로 밀어내도 링크가 다시 당겨서 효과가 제한적.

---

## 적용한 해결책

### 1. 초기 배치 알고리즘 강화 (격자/기본값 탈피)

- **컴포넌트 팩킹 시**:  
  - 반경을 **노드 수에 비례**하도록 변경  
    `minRadiusByCount = max(comp.length * 16, 55)`  
  - 셀 내 반경 하한/상한을  
    `max(cell*0.32, minRadiusByCount)` ~ `cell*0.48` 로 설정해, 처음부터 원형으로 넓게 퍼지도록 함.  
- **단일 컴포넌트 시**:  
  - `radiusX/Y = max(baseRadius, allNodes.length * 8)` 로 노드 수만큼 원을 키워 한 점 뭉침 방지.  
- **레이아웃 공간**:  
  - 최소 700×500 보장(이전 검토 반영 유지).  
- **뷰포트 준비**:  
  - `getGraphViewport()` 후 면적이 너무 작으면 80ms 대기 후 재측정해, DOM 준비 전에 작은 격자로 배치되는 일 방지.

### 2. 물리 엔진이 “스스로 퍼지게” (반발 우선 → 링크 나중)

- **반발만 워밍업 구간**  
  - `repulsionOnlyIter: 180`: 처음 180 스텝은 **링크(스프링) 힘 없이** 반발+충돌만 적용.  
  - 한 점/한 영역에 모인 초기 배치를 먼저 폭발시켜 퍼뜨린 뒤, 그 다음에 링크로 구조 유지.  
- **파라미터 조정**  
  - `repulsionStrength`: 160 → **280** (반발 강화).  
  - `collisionRadiusMultiplier`: 2.5 → **3.5** (겹치면 확실히 밀어냄).  
  - `edgeForce`: 0.05 → **0.022** (링크가 중심으로 당기는 힘 약화).  
  - `expansionFromCenter`: 0.025 → **0.04**.  
  - `maxIter`: 1000 → **1200**, `damping`: 0.78 → **0.82**.

### 3. 실시간으로 “퍼지는 것”이 보이게

- 시뮬레이션 **매 스텝(배치) 후** `renderGraph()` 호출.  
- 사용자가 “가만히 있어도 노드가 스스로 퍼지는” 것을 눈으로 확인 가능.

### 4. 기타 방어 로직

- **position 없는 노드**:  
  - 렌더 시 `positions[n.id]`가 없으면 뷰포트 기준 랜덤 한 점을 부여해, 한 점에 몰리거나 undefined로 깨지지 않도록 폴백.

---

## 기대 효과

- **초기 배치**: 격자/기본값이 아니라 “노드 수·컴포넌트별 원형”으로 처음부터 퍼진 상태로 시작.  
- **물리 엔진**: 반발 워밍업으로 먼저 퍼지고, 그 다음 링크가 구조만 유지 → “별자리”처럼 스스로 퍼짐.  
- **충돌**: 반경 배율 확대로 겹침 시 더 강하게 밀어냄.  
- **수동 분리**: 초기 배치 + 자동 퍼짐으로 드래그에 의존하는 비율이 크게 줄어듦.

변경 파일: `frontend/graph.js` (LAYOUT_CONFIG, initPositions, step, loadGraph, renderGraph).
